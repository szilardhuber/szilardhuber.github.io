---
layout: post
title:  "Learning game programming with Defold #1 - first steps"
date:   2020-05-24 13:55:22
categories: defold game
---
I like learning things. I like starting something and I always dream of even finishing that (notice that finishing is mostly a dream here :) ). I became a software developer because I fell in love with computers the moment I saw the first one. I still remember the feeling and the smells. I was a young kid and I went in to the public library where my sister worked as an intern to visit her for some reason I don't remember. I found her in a room where she organized some event where "old folks" (I guess they were way younger than I am now :) ) played with a computer game. This was a place and a time when computers were not something every family had a couple of. In fact there were about 20 guys in the room with a single Commodore 64 and they all took turns on who plays a round on that. From that time I know I want to spend my time with these marvellous machines.

![Commodore 64](https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Commodore-64-Computer-FL.jpg/600px-Commodore-64-Computer-FL.jpg)

And the first program I wrote when I got my own Commodore 64 from my parents a lot of time after this first meet was also some kind of a game. I created a trivia like game about at that time my favourite sport (handball) for my family. They would get a question and have 4 answers and they would need to guess the correct answer to win the game.

So since then I spent a significant amount of my time playing video games and I became a software developer. So you would assume I happened to learn game programming but for some reason it always avoided me. Every once in a while I stumbled upon a game development book, article, some blog posts or even a game development engine but there always was something that prevented me from actually starting it.

A couple of days ago however I read a [post on Hacker News](https://news.ycombinator.com/item?id=23232648) that the Defold game engine had become open source. I had't even heard about this game engine before but I had some spare time so I checked the post. I even looked at the Defold homepage and I even installed the engine. And then something happened. They have so nice tutorials. They are not too trivial to be boring but not too complex for me to get overwhelmed with it so I finished the [War Battles tutorial](https://defold.com/tutorials/war-battles/).

I don't want to quote anything from that tutorial, you should go and finish that on your own as it is very entertaining.

When you finish this you have a single scene with a map where you have a player who moves with the arrow keys, can even shoot rockets and there is a tank that can be fired at and that explodes if hit. You even have score displayed on the top of the screen and they give you some good suggestions on how to move forward with this. However by the time I came here I had at least 3 completely different directions I wanted to go and tons of ideas on what games I would like to create. So let's see together if I can finish a game until published and what that game will look like. To be honest in this moment I can only guess on both questions. :)

![My first game](/assets/defold1.png)

So as the next development let's add more tanks so that we can get more score than the 100 from the tutorial. I only have two game objects in my collection so I need to add the code for spawning the tanks either to the tank.script or to the player.script. It would seem natural to put this logic in the code for tanks.  But as they are the dynamically created instances it would happen that I don't have any objects to run my timer. So I decorate the player object even more which is not good as  it is already the one responsible for most of the logic but for now this should do. I assume at a later point I will need to add a level.script or logic.script to the collection. At this point I still don't know enough about the engine to decide where is the best place for general game logic like that.

{% gist fddae384a6b57cac419b25a05b2006af player.lua %}

First I add two "constants" to the script the Spawn Interval (this will be the time interval between two spawns of a tank) and the Max Speed which is the running speed of the player. This speed has nothing to do with this modification but while I'm here I feel I should refactor it to a property as well. Variables defined as `go.property` can be used in the code as `self.spawn_interval` and `self.max_speed`. Besides that you can edit these values in the editor with the nice property pane that already has properties for all kind of stuff.

The `init` function has nothing interesting. Variables needs to be initialized. `speed` is the current speed of the player (I added a walk mode when shift is pressed during the tutorial but right now there is absolutely no point in walking) while `max_speed` is the unmodified speed of the player. Later on I could use this speed to alter player speed based on terrain (slower in sand for example). So even though it does not have any meaningful function right now I leave it in.

With the same logic, the timer variable holds the actual value of the timer that is updated in every update and if that goes below zero we add a new tank to the map and reset the timer. Actually this is exactly what can be seen in the update function. I don't like the way I find a random position for the new tank but for now it is good enough. Later on I need to find a programatical way of finding a random position on the map without knowing here the width and height of the play area. I also don't randomize the rotation but use the player's rotation (this comes by copy-pasting from the script for the rocket).

It is a huge surprise to me that now I have a game that is actually quite enjoyable. I don't mean it would be able to keep anyone entertained for more than 2 minutes but for that 2 minutes it is fun. I was lucky with the timings. Spawning a tank every two seconds while the player has three seconds to shoot them actually makes this quite a challenging task on this size of a map with this speed of the player. As you can see there are already lots of game affecting parameters. I now imagine the game to go in a way where player starts quite dumb with low speed, low damage rockets and gets some coins for every kill and can upgrade these parameters to get further in the game. Better rocket, better "shoes", slower death and such. I also don't really like the theme of tanks and rocket. Yet finding the right tilemap and sprites would be too big of a distraction at this phase as this game could easliy turn out to be a Candy Crush clone instead of some wargame. :) I already checked that there are tons of free resources everywhere so my only concern is if I will be able to find assets from different places that become a coherent visual experience in a game. If not I might just stick with these assets coming with the tutorial).

What is absolutely needed no matter what this game become is some collision logic between the player and the terrain. I don't want the player to just float through the trees and rocks and such so it needs to be addressed. After some googling the official tutorial seems to be an example on [Tilemap collisions](https://defold.com/examples/tilemap/collisions/). I tried to follow the example but had some difficulties. First it does not really emphasize how to classify tiles on your tilesource. If you have the same problems see the part on (Tile source collision shapes)[https://defold.com/manuals/tilesource/#tile-source-collision-shapes]. I also got some difficulties with different kind of collisions. For the tilesource you would need Static and if you don't want the physics engine to do magic for you with gravity and such use Kinematic for the player. Also the group and the mask is only straightforward if you read the manual first which I did not do :) You should use the mask for the other objects that you want to collide with and the group to define an id for the current object. Mask can be a comma separated list but both parts of the collision should define the mask and the group accordingly. For the tilemap collision object you don't need to define group as that comes from the tilesource. And one more thing that took me hours to discover...you absolutley MUST define the collision image in the tilesource properties. Basicaly you need to specify the image for the tilesource twice. Once in the image property and once in the collision property.

And I almost forgot. In the example they use Dynamic collision objects. This means they don't have to deal with the physics of the collision, it "just works" the way they want in the example. However my game is not a top-down game and I had to use Kinematic collision and for that I need to handle that manually. This is something I guess I will need to understand in the future but for now I just read an idea on a forum post and dropped it in the code with some manual tweaking and the result is good enough for me at this point.

{% gist fddae384a6b57cac419b25a05b2006af player_on_message.lua %}

This is it. Now my player bumps into the objects on the terrain (not to the tanks) and our game already has some entertainment factor. In the next post I will make it possible to restart the game after losing and maybe even store highscore as well. If you happen to read this post and have any questions or figure that I am completely wrong with any part of my approach, don't hesitate to let me know!
